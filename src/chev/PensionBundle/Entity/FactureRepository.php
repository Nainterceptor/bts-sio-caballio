<?php

namespace chev\PensionBundle\Entity;

use Doctrine\ORM\EntityRepository, 
    Doctrine\ORM\Query;

/**
 * FactureRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class FactureRepository extends EntityRepository
{
	/**
	 * Retoune la facture suivi de plusieurs parametres :	
	 * 	- nbMois le nombre de mois à facturé
	 * 	- nbJours la durée exacte du bail
	 * 	- montant
	 * 	- TVA
	 * 	- montantTVA
	 * 
	 * @param Facture $facture La facture
	 * 
	 * @return entity suivi tableau de parametre
	 */
	private function retourneFacture($facture) {
		$interval = $moisTotal = 0;
		
		$interval = $facture['facture']->getDateDebut()->diff($facture['facture']->getDateFin(), true);
		if ($interval->days > 0) {
			if ($interval->d == 0)
				$moisTotal = $interval->m;
			else
				$moisTotal = $interval->m + 1;
		}
		
		$facture['nbMois'] = $moisTotal. " mois";
		$facture['nbJours'] = $interval->m." mois et ".$interval->d." jours.";
		$facture['montant'] = $moisTotal*$facture['prix'];
		$facture['TVA'] = ($moisTotal*$facture['prix']) * 0.196;
		$facture['montantTVA'] = ($moisTotal*$facture['prix']) * 1.196;
		$facture['montantTVA'] = number_format($facture['montantTVA'], 2);
		
		if ($facture['facture']->getSupplements() != null) {
			$facture['totalMontantTVA'] = $facture['montantTVA'];
			foreach ($facture['facture']->getSupplements() as $supp) {
				$facture['totalMontantTVA'] += $supp->getPrix();
			}
		}
		
    	return $facture;
	}
	
	/**
     * Trouver toutes les factures par le centre ayant ce gérant
     * 
     * @param User $gerant Le gérant
     *
     * @return Tableau d'entités
     */
    public function findByCentreGerant($gerant) {
        return $this->_em
                ->createQuery('SELECT f FROM chevPensionBundle:Facture f
                               JOIN f.box b 
                               JOIN b.type t
                               JOIN t.centre c
                               WHERE c.gerant = :gerant')
                ->setParameter(':gerant', $gerant)
                ->getResult();
    }
	
	/**
     * Trouver une facture par le centre ayant ce gérant
     * 
     * @param User $gerant Le gérant
     *
     * @return entity
     */
    public function findOneByCentreGerant($gerant, $id) {
        return $this->_em
                ->createQuery('SELECT f FROM chevPensionBundle:Facture f
                               JOIN f.box b 
                               JOIN b.type t
                               JOIN t.centre c
                               WHERE c.gerant = :gerant
                               AND f.id = :id')
                ->setParameter(':gerant', $gerant)
                ->setParameter(':id', $id)
                ->getOneOrNullResult();
    }
	/**
     * Trouver une facture avec le montant par l'id
     * 
     * @param User $gerant Le gérant
     * @param int $id l'id
     * 
     * @return Entity
     */
    public function findAM($id) {
    	try {
    		$em = $this->getEntityManager();
            $query = ' SELECT f AS facture, t.prix'
                   . ' FROM chevPensionBundle:Facture f'
                   . ' JOIN f.box b'
                   . ' JOIN b.type t'
                   . ' WHERE f.id = :id';
    		$facture = $em->createQuery($query)
    					  ->setParameter(':id', $id)
    					  ->getOneOrNullResult();
        } catch (\Doctrine\ORM\NoResultException $e) {
            return null;
        }
		if($facture == null)
            return null;
		
        return $this->retourneFacture($facture);
    }
    /**
     * Trouver une facture avec le montant par le centre ayant ce gérant et l'id
     * 
     * @param User $gerant Le gérant
     * @param int $id l'id
     * 
     * @return Entity
     */
    public function findOneByCentreGerantAM($gerant, $id) {
    	try {
    		$em = $this->getEntityManager();
            $query = ' SELECT f AS facture, t.prix'
                   . ' FROM chevPensionBundle:Facture f'
                   . ' JOIN f.box b'
                   . ' JOIN b.type t'
                   . ' JOIN t.centre c'
                   . ' WHERE c.gerant = :gerant'
                   . ' AND f.id = :id';
    		$facture = $em->createQuery($query)
						  ->setParameter(':gerant', $gerant)
    					  ->setParameter(':id', $id)
    					  ->getOneOrNullResult();
        } catch (\Doctrine\ORM\NoResultException $e) {
            return null;
        }
		if($facture == null)
            return null;
		
        return $this->retourneFacture($facture);
    }
	/**
     * Trouver une facture avec le montant par l'utilisateur et l'id
     * 
     * @param User $gerant Le gérant
     * @param int $id l'id
     * 
     * @return Entity
     */
	public function findOneByUtilisateurAM($user, $id) {
    	try {
    		$em = $this->getEntityManager();
            $query = 'SELECT f AS facture, t.prix'
                   . ' FROM chevPensionBundle:Facture f'
                   . ' JOIN f.box b'
                   . ' JOIN b.type t'
                   . ' WHERE f.utilisateur = :utilisateur'
                   . ' AND f.id = :id';
    		$facture = $em->createQuery($query)
						  ->setParameter(':utilisateur', $user)
    					  ->setParameter(':id', $id)
    					  ->getOneOrNullResult();
        } catch (\Doctrine\ORM\NoResultException $e) {
            return null;
        }
		if($facture == null)
            return null;
		
        return $this->retourneFacture($facture);
    }
}
